services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    container_name: compression_backend
    ports:
      - "8443:8000"
    environment:
      - PYTHONPATH=/app
      - DEBUG=false
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/compression_db
      - REDIS_URL=redis://redis:6379
      - API_VERSION=1.0.0
      - CORS_ORIGINS=http://localhost:3000,http://localhost:8449,http://frontend:3000
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
    develop:
      watch:
        - action: sync
          path: ./backend/app
          target: /app/app
        - action: rebuild
          path: ./backend/requirements.txt
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./logs:/app/logs
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: "2.0"
        reservations:
          memory: 2G
          cpus: "1.0"
    command:
      [
        "uvicorn",
        "main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8000",
        "--workers",
        "1",
      ]
    # Temporarily disable health check - server is working but health check is failing
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 40s
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
      target: runtime
      args:
        BUILDKIT_INLINE_CACHE: 1
    container_name: compression_frontend
    ports:
      - "8449:3000"
    environment:
      - NODE_OPTIONS=--max-old-space-size=12288
      - NEXT_TELEMETRY_DISABLED=1
      - NEXT_PUBLIC_API_URL=http://localhost:8443
      - NEXT_PUBLIC_API_URL_LOCAL=http://localhost:8443
      # File watching optimizations
      - WATCHPACK_POLLING=false
      - CHOKIDAR_USEPOLLING=false
      - CHOKIDAR_INTERVAL=300
      - CHOKIDAR_USE_FS_EVENTS=true
      # Webpack memory optimizations
      - WEBPACK_MEMORY_CACHE=false
      - WEBPACK_DEV_SERVER_MEMORY_CACHE=false
      # Next.js development optimizations
      - NEXT_FAST_REFRESH=true
      - NODE_ENV=development
    develop:
      watch:
        - action: sync
          path: ./frontend/src
          target: /app/src
        - action: sync
          path: ./frontend/public
          target: /app/public
        - action: sync
          path: ./frontend/next.config.js
          target: /app/next.config.js
        - action: rebuild
          path: ./frontend/package.json
        - action: rebuild
          path: ./frontend/package-lock.json
    depends_on:
      backend:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 12G
          cpus: "3.0"
        reservations:
          memory: 8G
          cpus: "2.0"
    # Enhanced health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 120s
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    container_name: compression_postgres
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_DB=compression_db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/init.sql:/docker-entrypoint-initdb.d/init.sql
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 256M
          cpus: "0.25"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d compression_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: compression_redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"
        reservations:
          memory: 128M
          cpus: "0.1"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    container_name: compression_nginx
    ports:
      - "8445:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/conf.d:/etc/nginx/conf.d
    depends_on:
      - frontend
      - backend
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.1"
        reservations:
          memory: 64M
          cpus: "0.05"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  default:
    driver: bridge
